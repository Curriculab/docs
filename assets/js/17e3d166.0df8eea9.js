"use strict";(globalThis.webpackChunkcurriculab_docs=globalThis.webpackChunkcurriculab_docs||[]).push([[6734],{7448(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"decisions/optimistic-concurrency-enrollment","title":"ADR-004: Database Constraint Enforcement for Section Enrollment Concurrency","description":"Decision to use INSERT plus a DB constraint for safe concurrent section enrollment.","source":"@site/decisions/004-optimistic-concurrency-enrollment.md","sourceDirName":"decisions","slug":"/decisions/optimistic-concurrency-enrollment","permalink":"/docs/decisions/optimistic-concurrency-enrollment","draft":false,"unlisted":false,"editUrl":"https://github.com/Curriculab/docs/edit/main/decisions/004-optimistic-concurrency-enrollment.md","tags":[],"version":"current","lastUpdatedAt":1771547468000,"sidebarPosition":4,"frontMatter":{"sidebar_label":"ADR-004: Enrollment Concurrency","description":"Decision to use INSERT plus a DB constraint for safe concurrent section enrollment."},"sidebar":"decisionsSidebar","previous":{"title":"ADR-003: User/Student Inheritance","permalink":"/docs/decisions/user-student-joined-table-inheritance"},"next":{"title":"ADR-005: Docusaurus","permalink":"/docs/decisions/docusaurus-documentation-platform"}}');var i=t(4848),o=t(8453);const s={sidebar_label:"ADR-004: Enrollment Concurrency",description:"Decision to use INSERT plus a DB constraint for safe concurrent section enrollment."},c="ADR-004: Database Constraint Enforcement for Section Enrollment Concurrency",l={},a=[{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Consequences",id:"consequences",level:2},{value:"Alternatives Considered",id:"alternatives-considered",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"adr-004-database-constraint-enforcement-for-section-enrollment-concurrency",children:"ADR-004: Database Constraint Enforcement for Section Enrollment Concurrency"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Date:"})," 2026-02-19\n",(0,i.jsx)(n.strong,{children:"Status:"})," Accepted"]}),"\n",(0,i.jsx)(n.h2,{id:"context",children:"Context"}),"\n",(0,i.jsxs)(n.p,{children:["During peak registration windows, many students simultaneously attempt to enroll in popular course sections. ",(0,i.jsx)(n.code,{children:"Section.capacity"})," must never be exceeded \u2014 over-enrollment is a correctness failure with direct consequences for students and instructors."]}),"\n",(0,i.jsxs)(n.p,{children:["A naive application-level approach reads the current ",(0,i.jsx)(n.code,{children:"enrolled_count"}),", compares it to ",(0,i.jsx)(n.code,{children:"capacity"}),", and then inserts an ",(0,i.jsx)(n.code,{children:"Enrollment"})," row if space is available. This is a classic ",(0,i.jsx)(n.strong,{children:"time-of-check / time-of-use (TOCTOU)"})," race condition: two concurrent requests can both read ",(0,i.jsx)(n.code,{children:"enrolled_count = 24"})," against a ",(0,i.jsx)(n.code,{children:"capacity = 25"}),", both conclude a seat is available, and both INSERT \u2014 resulting in 26 enrolled students."]}),"\n",(0,i.jsx)(n.p,{children:"The solution must be correct under concurrent load without introducing excessive lock contention that degrades performance during the registration peak."}),"\n",(0,i.jsx)(n.h2,{id:"decision",children:"Decision"}),"\n",(0,i.jsxs)(n.p,{children:["Capacity enforcement is delegated to the ",(0,i.jsx)(n.strong,{children:"database layer"})," via a ",(0,i.jsx)(n.code,{children:"CHECK"})," constraint or ",(0,i.jsx)(n.code,{children:"AFTER INSERT"})," trigger on ",(0,i.jsx)(n.code,{children:"Enrollment"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The implementation approach for ",(0,i.jsx)(n.code,{children:"Curriculab/db"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Section.enrolled_count"})," is a ",(0,i.jsx)(n.strong,{children:"derived integer"})," maintained by a trigger (or computed via a subquery in a ",(0,i.jsx)(n.code,{children:"CHECK"}),"). It is not a raw writeable column."]}),"\n",(0,i.jsxs)(n.li,{children:["An ",(0,i.jsx)(n.code,{children:"AFTER INSERT"})," trigger on ",(0,i.jsx)(n.code,{children:"Enrollment"})," increments ",(0,i.jsx)(n.code,{children:"enrolled_count"})," on the parent ",(0,i.jsx)(n.code,{children:"Section"})," row ",(0,i.jsx)(n.strong,{children:"within the same transaction"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"CHECK"})," constraint (or the trigger itself) validates ",(0,i.jsx)(n.code,{children:"enrolled_count <= capacity"})," and raises an exception if the constraint is violated."]}),"\n",(0,i.jsxs)(n.li,{children:["PostgreSQL's MVCC ensures that two concurrent transactions incrementing ",(0,i.jsx)(n.code,{children:"enrolled_count"})," on the same ",(0,i.jsx)(n.code,{children:"Section"})," row will serialize \u2014 one will see the committed value from the other and either succeed or fail the constraint cleanly."]}),"\n",(0,i.jsx)(n.li,{children:'The API layer catches the constraint violation exception and returns an HTTP 409 (Conflict) with a user-facing "section is full" message \u2014 not a generic 500 error.'}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"UNIQUE (student_id, section_id)"})," constraint on ",(0,i.jsx)(n.code,{children:"Enrollment"})," independently prevents duplicate enrollments."]}),"\n",(0,i.jsx)(n.h2,{id:"consequences",children:"Consequences"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Positive"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Correctness guaranteed at the database layer regardless of application server count or deployment topology."}),"\n",(0,i.jsx)(n.li,{children:"No explicit application-level locks or coordination required."}),"\n",(0,i.jsx)(n.li,{children:"Scales naturally: each concurrent INSERT either commits or fails; there is no shared in-memory lock to contend over."}),"\n",(0,i.jsx)(n.li,{children:"The constraint failure is a clear, catchable exception with a specific error code \u2014 easy for the API to translate into a business-logic response."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"SELECT ... FOR UPDATE"})," remains available as an escalation path (see Alternatives) if the trigger-based approach shows contention under profiling."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Negative"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Constraint violations must be handled as expected business events in the API layer, not just error conditions. All enrollment code paths must catch and translate the specific PostgreSQL exception."}),"\n",(0,i.jsx)(n.li,{children:"Testing correctness requires concurrent load simulation \u2014 unit tests that run serially will not expose race conditions."}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"enrolled_count"})," is stored (not purely calculated on read), the trigger must be carefully tested to ensure it fires correctly on INSERT, on DELETE (drop), and on status changes (e.g., ",(0,i.jsx)(n.code,{children:"Enrollment.completion_status"})," changing from ",(0,i.jsx)(n.code,{children:"enrolled"})," to ",(0,i.jsx)(n.code,{children:"withdrawn"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Neutral"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"UNIQUE (student_id, section_id)"})," constraint on ",(0,i.jsx)(n.code,{children:"Enrollment"})," handles the duplicate-registration case independently and does not interact with capacity enforcement."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"alternatives-considered",children:"Alternatives Considered"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Naive check-then-insert (application layer)"}),"\nRead ",(0,i.jsx)(n.code,{children:"enrolled_count"}),", compare to ",(0,i.jsx)(n.code,{children:"capacity"}),", insert if space available. Subject to TOCTOU race conditions under any concurrency. ",(0,i.jsx)(n.strong,{children:"Do not use."})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"SELECT ... FOR UPDATE"})," on the Section row"]}),"\nThe API acquires a row-level exclusive lock on ",(0,i.jsx)(n.code,{children:"Section"})," before checking capacity and inserting ",(0,i.jsx)(n.code,{children:"Enrollment"}),". Guarantees correctness by serializing all concurrent enrollments for a given section. The tradeoff: the lock is held for the duration of the transaction, meaning all concurrent enrollment attempts for the same section queue behind each other. Under peak registration for a high-demand section, this can create a lock-wait queue. This approach is retained as a ",(0,i.jsx)(n.strong,{children:"fallback"})," if the constraint-based approach proves insufficient under profiling."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["Distributed lock (e.g., Redis ",(0,i.jsx)(n.code,{children:"SETNX"}),")"]}),"\nAcquire an external lock keyed on ",(0,i.jsx)(n.code,{children:"section_id"})," before enrolling. Adds a Redis dependency and distributed lock complexity (lock expiry, crash recovery). Rejected as overengineering when the database can enforce the constraint directly."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Serializable transaction isolation"}),"\nRun all enrollment transactions at ",(0,i.jsx)(n.code,{children:"ISOLATION LEVEL SERIALIZABLE"}),". PostgreSQL's SSI would detect the write-write conflict and abort one of the concurrent transactions. Correct, but applies globally and adds overhead to all transactions, not just enrollment. Rejected in favour of targeted constraint enforcement."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Application-layer semaphore / in-process lock"}),"\nAcquire a per-section semaphore in the API process. Correct only for single-server deployments; fails when multiple API server instances run concurrently. Rejected."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>s,x:()=>c});var r=t(6540);const i={},o=r.createContext(i);function s(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);